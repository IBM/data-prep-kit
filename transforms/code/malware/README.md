# Malware Transform 
Please see the set of
[transform project conventions](../../README.md#Transform-Project-Conventions)
for details on general project conventions, transform configuration,
testing and IDE set up.

## Summary 
This filter scans the 'contents' column of an input table using [ClamAV](https://www.clamav.net/), and outputs corresponding tables containing 'virus_detection' column (by default).

If a virus is detected, the 'virus_detection' column contains the detected virus signature name; otherwise [null](https://arrow.apache.org/docs/python/generated/pyarrow.null.html).

### Pre-requisites for Mac

For testing and running this transform on local, we are using a unix socket shared with a docker container.
However, docker for mac doesn't support a shared unix socket.
For Mac users, ClamAV will be set up by running `make venv`.
If thet script doesn't work for you, please ensure that you have installed `clamd` command, and it runs with a local unix socket: `/var/run/clamav/clamd.ctl`.

#### Example for manual set up for Mac:

1. Install ClamAV with Homebrew
    ```sh
    brew install clamav
    ```
1. Copy and edit config files.
    ```sh
    cp $(brew --prefix)/etc/clamav/clamd.conf.sample $(brew --prefix)/etc/clamav/clamd.conf
    sed -i '' -e 's/^Example/# Example/' $(brew --prefix)/etc/clamav/clamd.conf
    echo "DatabaseDirectory /var/lib/clamav" >> $(brew --prefix)/etc/clamav/clamd.conf
    echo "LocalSocket /var/run/clamav/clamd.ctl" >> $(brew --prefix)/etc/clamav/clamd.conf
    cp $(brew --prefix)/etc/clamav/freshclam.conf.sample $(brew --prefix)/etc/clamav/freshclam.conf
    sed -i '' -e 's/^Example/# Example/' $(brew --prefix)/etc/clamav/freshclam.conf
    echo "DatabaseDirectory /var/lib/clamav" >> $(brew --prefix)/etc/clamav/freshclam.conf
    ```
1. Create a directory for a local unix socket
    ```sh
    sudo mkdir -p /var/run/clamav
    sudo chown $(id -u):$(id -g) /var/run/clamav
    ```
1. Create a direcotry for a database of ClamAV
    ```sh
    sudo mkdir -p /var/lib/clamav
    sudo chown $(id -u):$(id -g) /var/lib/clamav
    ```
1. Update a database of ClamAV
    ```sh
    freshclam
    ```
1. Edit `venv/bin/activate`, and add following lines to start `clamd` by `source venv/bin/activate`
    ```sh
    if [ ! -e /var/run/clamav/clamd.ctl ]; then
        clamd --config-file=$(brew --prefix)/etc/clamav/clamd.conf
    fi
    ```

## Configuration and Command Line Options

The set of dictionary keys holding [MalwareTransform](src/malware_transform.py) 
configuration for values are as follows:

* _malware_input_column_ - specifies the input column's name to scan. (default: `contents`)
* _malware_output_column_ - specifies the output column's name of the detected virus signature name. (default: `virus_detection`)

## Running
You can run the [malware_local_ray.py](src/malware_local_ray.py) to
transform the `sample.parquet` file in [test input data](test-data/input) 
to an `output` directory.  The directory will contain both the new
annotated `sample.parquet` file and the `metadata.json` file.

#### Running as ray-based application
<pre>
% source venv/bin/activate
(venv) % cd src
(venv) % python malware_local_ray.py
15:08:22 INFO - Running locally
15:08:22 INFO - malware parameters are : {'malware_input_column': 'contents', 'malware_output_column': 'virus_detection'}
15:08:22 INFO - Validated local data factory data_ input_folder - /root/data-prep-lab/transforms/code/malware/test-data/input output_folder - /root/data-prep-lab/transforms/code/malware/output
15:08:22 INFO - data factory data_ Not using data sets, checkpointing False, max files -1, random samples -1, files to use ['.parquet']
15:08:22 INFO - number of workers 5 worker options {'num_cpus': 0.8}
15:08:22 INFO - pipeline id pipeline_id; number workers 5
15:08:22 INFO - job details {'job category': 'preprocessing', 'job name': 'Malware', 'job type': 'ray', 'job id': 'job_id'}
15:08:22 INFO - code location {'github': 'github', 'commit_hash': '12345', 'path': 'path'}
15:08:22 INFO - actor creation delay 0
2024-04-17 15:08:25,289	INFO worker.py:1715 -- Started a local Ray instance. View the dashboard at 127.0.0.1:8265
(orchestrate pid=89083) 15:08:26 INFO - orchestrator started at 2024-04-17 15:08:26
(orchestrate pid=89083) 15:08:26 INFO - Number of files is 1, source profile {'max_file_size': 0.00240325927734375, 'min_file_size': 0.00240325927734375, 'total_file_size': 0.00240325927734375}
(orchestrate pid=89083) 15:08:26 INFO - Cluster resources: {'cpus': 10, 'gpus': 0, 'memory': 15.222511291503906, 'object_store': 2.0}
(orchestrate pid=89083) 15:08:26 INFO - Number of workers - 5 with {'num_cpus': 0.8} each
(orchestrate pid=89083) 15:08:26 INFO - Completed 0 files in 2.968311309814453e-06 min. Waiting for completion
(orchestrate pid=89083) 15:08:27 INFO - Completed processing in 0.017241581281026205 min
(orchestrate pid=89083) 15:08:27 INFO - done flushing in 0.0017011165618896484 sec
(orchestrate pid=89083) 15:08:27 INFO - Saved job metadata: {'pipeline': 'pipeline_id', 'job details': {'job category': 'preprocessing', 'job name': 'Malware', 'job type': 'ray', 'job id': 'job_id', 'start_time': '2024-04-17 15:08:26', 'end_time': '2024-04-17 15:08:27', 'status': 'success'}, 'code': {'github': 'github', 'commit_hash': '12345', 'path': 'path'}, 'job_input_params': {'malware_input_column': 'contents', 'malware_output_column': 'virus_detection', 'checkpointing': False, 'max_files': -1, 'random_samples': -1, 'files_to_use': ['.parquet'], 'number of workers': 5, 'worker options': {'num_cpus': 0.8}, 'actor creation delay': 0}, 'execution_stats': {'cpus': 10, 'gpus': 0, 'memory': 15.222511291503906, 'object_store': 2.0}, 'job_output_stats': {'source_files': 1, 'source_size': 104, 'result_files': 1, 'result_size': 133, 'table_processing': 0.08824610710144043, 'clean': 1, 'infected': 1}}.
(TransformTableProcessor pid=89089) 15:08:27 INFO - skipping flush, no name for file is defined
15:08:37 INFO - Completed execution in 0.25710506439208985 min, execution result 0
(TransformTableProcessor pid=89092) 15:08:27 INFO - skipping flush, no name for file is defined [repeated 3x across cluster] (Ray deduplicates logs by default. Set RAY_DEDUP_LOGS=0 to disable log deduplication, or see https://docs.ray.io/en/master/ray-observability/ray-logging.html#log-deduplication for more options.)
%
</pre>

#### Running as pure python application
<pre>
% source venv/bin/activate
(venv) % cd src
(venv) % python malware_local.py
input table: pyarrow.Table
contents: string
document_id: string
----
contents: [["THIS IS SAFE","X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"]]
document_id: [["0001","0002"]]

output table: [pyarrow.Table
contents: string
document_id: string
virus_detection: string
----
contents: [["THIS IS SAFE","X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"]]
document_id: [["0001","0002"]]
virus_detection: [[null,"Win.Test.EICAR_HDB-1"]]]
output metadata : {'clean': 1, 'infected': 1}
(venv) % deactivate
% ls ../output
metadata.json  sample.parquet
%
</pre>

### Metadata Fields
As shown in the output of the local run of malware transform, the metadata contains several statistics:
* Global statistics:  
  * `infected`: total number of documents (rows) in which any malwares were detected.   
  * `clean`: total number of documents (rows) in which no malwares were detected.

### Building the Docker Image
```shell
% make image 
...

````

In addition, there are some useful make targets (see conventions above) or use `make help` to see a list of available targets.

### Launched Command Line Options 
When running the transform with the Ray launcher (i.e. TransformLauncher),
the following command line arguments are available in addition to 
[the options provided by the launcher](../../../data-processing-lib/doc/launcher-options.md).
```
  --malware_input_column MALWARE_INPUT_COLUMN
                        input column name
  --malware_output_column MALWARE_OUTPUT_COLUMN
                        output column name
```
