ifndef T_SET
T_SET=all
endif


venv:  
	$(MAKE) .defaults.create-venv

test::	test-src

clean:: .transforms.clean
	-rm -fr src

image:: .transforms.python-image

run-ut::
	source venv/bin/activate;       \
	if [ -e requirements.test.txt ];	then	\
		$(PYTHON) -m pip install -r requirements.test.txt ;	 \
	fi;	\
	for T in $(TRANSFORMS_NAMES); do                    \
	    echo running unit test on: $$T ; \
		$(PYTEST) $(REPOROOT)/transforms/$$T/$(PACKAGING_RUN_TIME)/test; \
	done;
	@# Help: Setup environment and run unit tests for all transforms


setup: .transforms.setup venv
	$(MAKE) src
	source venv/bin/activate;       \
	$(PYTHON) -m pip install . 
	@# Help: Do any default transform setup before running make src and setting up a test environment
	

requirements:
	if [ -e requirements.$(T_SET).txt ];	then	\
		cp requirements.$(T_SET).txt requirements.txt ;	\
	fi

pkg-name:
	if [ $(TRANSFORM_PKG) ]; then \
	    cat pyproject.toml | sed -e 				\
		's/^name[ ]*=.*/name = "'${TRANSFORM_PKG}'"/' 	\
		> tt.toml;						\
	    mv tt.toml pyproject.toml;					\
	fi

is-patch:
	if [ $(IS_PATCH) ]; then \
	    cat pyproject.toml | sed -e 				\
		's/^version[ ]*=[ ]*"\(.*\).dev.*/version = "\1"/' 	\
		> tt.toml;						\
	    mv tt.toml pyproject.toml;					\
	fi

#####################################################
# to build a patched release, use make IS_PATCH=1 src
#####################################################
src:
	mkdir src
	make requirements
	make pkg-name
	make is-patch
	for T in $(shell echo $(TRANSFORMS_NAMES)); do                    \
	    echo copy src from  $$T ; \
		cp -R $(REPOROOT)/transforms/$$T/$(PACKAGING_RUN_TIME)/src/* src ; \
		rm -fr *.egg-info ; \
		rm -fr dist ; \
		rm -fr build ; \
	done;
	@# Help: Setup src folder and remove old distribution. to setup for a patched release use: make IS_PATCH=1 $@

		
build:: build-dist
        
publish:: publish-dist
        
build-dist:: src .defaults.build-dist 
	@# Help: build the distribution for publishing to pypi. to build a patch release (no .devN) use: make IS_PATCH=1 $@

publish-dist:: .defaults.publish-dist


